\section{Lecture 7 -- 5th May 2025}\label{sec: lecture 5}
We state without proof flatness in another setting. 
\begin{proposition}[Miracle Flatness]\label{prop: miracle flatness}
    Let $X,Y$ be smooth integral $k$-schemes and $f:X\to Y$ a morphism such that $\dim(X_{y})$ is constant. Then $f$ is flat. 
\end{proposition}
\begin{proof}
   This is local, so we can reduce to the case of $f$ induced by a ring map $B\to A$ which is \cite[\href{https://stacks.math.columbia.edu/tag/00R4}{Tag 00R4}]{stacks-project}.  
\end{proof}
Having discussed flatness, we can turn to a discussion of smoothness of morphisms, generalizing \Cref{def: smooth scheme}. 
\begin{definition}[Smooth Morphism at a Point]\label{def: smooth morphism}
    Let $f:X\to Y$ be a morphism locally of finite type. $f$ is smooth at $x\in X$ if $f$ is flat at $x$ and the fiber $X_{f(x)}$ is smooth over $\kappa(f(x))$. 
\end{definition}
\begin{remark}
    That is, $\Ocal_{X,x}$ is a flat $\Ocal_{Y,f(x)}$-module and $X_{f(x)}=X\times_{Y}\spec(\kappa(f(x)))$ is a smooth $\kappa(f(x))$-scheme by the Cartesian diagram 
    $$% https://q.uiver.app/#q=WzAsNCxbMCwwLCJYX3tmKHgpfSJdLFswLDEsIlxcc3BlYyhcXGthcHBhKGYoeCkpKSJdLFsyLDAsIlgiXSxbMiwxLCJZLiJdLFswLDJdLFsyLDNdLFsxLDNdLFswLDFdXQ==
    \begin{tikzcd}
        {X_{f(x)}} && X \\
        {\spec(\kappa(f(x)))} && {Y.}
        \arrow[from=1-1, to=1-3]
        \arrow[from=1-1, to=2-1]
        \arrow[from=1-3, to=2-3]
        \arrow[from=2-1, to=2-3]
    \end{tikzcd}$$
\end{remark}
This definition globalizes. 
\begin{definition}[Smooth Morphism]\label{def: smooth morphism}
    Let $f:X\to Y$ be a morphism locally of finite type. $f$ is smooth if $f$ is smooth at all $x\in X$. 
\end{definition}
\begin{example}
    Let $W$ be a smooth $k$-scheme and $Y$ any $k$-scheme. Let $X=W\times_{k}Y$ with $f:X\to Y$ the natural projection. $f$ is smooth -- by miracle flatness the dimensions of the fibers are constant and are $W$ which is $\kappa(f(x))$-smooth since smoothness is preserved under base change. 
\end{example}
\begin{example}\label{ex: affine and projective space and bundles are smooth}
    Let $Y$ be any scheme. The projections $\A^{n}_{Y}\to Y, \PP^{n}_{Y}\to Y$ are smooth. More generally for $\Ecal$ locally free of finite rank on $Y$, the (total spaces of the) associated vector bundle $\VV(\Ecal)\to Y$ and projective bundle $\PP(\Ecal)\to Y$ are smooth.  
\end{example}
Recall that for $f:X\to Y$ a morphism of schemes over $k$ the \Cref{prop: tensor exact sequence} gives an exact sequence of sheaves 
$$f^{*}\Omega_{Y/k}^{1}\to\Omega_{X/k}^{1}\to\Omega_{X/Y}^{1}\to0.$$
As it turns out, smoothness of morphisms can be determined by $\Omega^{1}_{X/Y}$, in analogy to how smoothness of schemes is determined by $\Omega^{1}_{X/k}$. For this, we will require the following lemma. 
\begin{lemma}\label{lem: is closed of flat}
    Let $f:X\to Y$ be a locally finite type morphism, $x\in X$ with $f(x)=y$ and $d=\dim(X_{y})$. There exists a closed immersion $X\to W$ over $Y$ such that $W$ is smooth at $x$ over $y$ of dimension $d$. 
\end{lemma}
\begin{proof}
   Since $f$ is locally of finite type, we can factor $f$ as 
   $$% https://q.uiver.app/#q=WzAsMyxbMCwwLCJYIl0sWzIsMCwiXFxBXntufV97WX0iXSxbMSwxLCJZIl0sWzEsMiwicCJdLFswLDIsImYiLDJdLFswLDEsImkiXV0=
   \begin{tikzcd}
       X && {\A^{n}_{Y}} \\
       & Y
       \arrow["i", from=1-1, to=1-3]
       \arrow["f"', from=1-1, to=2-2]
       \arrow["p", from=1-3, to=2-2]
   \end{tikzcd}$$
   where $i$ is a closed immersion and $p$ is the projection. As in \Cref{ex: affine and projective space and bundles are smooth}, $p$ is smooth so $\Omega^{1}_{\A^{n}_{Y}/Y}$ is locally free of rank $n$, but not of rank $d$. We find a closed subscheme of $\A^{n}_{Y}$ such that the sheaf of relative differentials is locally free of rank $d$. 

   Let $\Ical_{X}$ be the ideal sheaf of $X$ in $\A^{n}_{Y}$ so by \Cref{prop: ideal exact sequence}, we have an exact sequence 
   \begin{equation}\label{eqn: ideal exact sequence technical lemma}
    \Ical_{X}/\Ical_{X}^{2}\to\Omega^{1}_{\A^{n}_{Y}/Y}|_{i(X)}\to\Omega_{X/Y}\to0.
   \end{equation}
   Now letting $\Jcal$ be the ideal sheaf of $X_{y}\in\A^{n}_{\kappa(y)}$ we have an exact sequence 
   \begin{equation}\label{eqn: exact sequence technical lemma}
    \Jcal\to\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}\to\Omega_{X_{y}/\kappa(y)}^{1}\to0
   \end{equation}
   where $\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}$ is locally free of rank $n$ and $\Omega_{X_{y}/\kappa(y)}^{1}$ is locally free of rank $d$. Then 
   $$\ker\left(\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}\to\Omega_{X_{y}/\kappa(y)}^{1}\right)$$ 
   is locally free of rank $n-d$. Base changing (\ref{eqn: ideal exact sequence technical lemma}) and (\ref{eqn: exact sequence technical lemma}) by $\kappa(x)$, we get a diagram 
   $$% https://q.uiver.app/#q=WzAsOCxbMCwwLCJcXEljYWxfe1h9L1xcSWNhbF97WH1eezJ9XFxvdGltZXNcXGthcHBhKHgpIl0sWzIsMCwiXFxPbWVnYV57MX1fe1xcQV57bn1fe1l9L1l9fF97aShYKX1cXG90aW1lc1xca2FwcGEoeCkiXSxbNCwwLCJcXE9tZWdhXnsxfV97WC9ZfVxcb3RpbWVzXFxrYXBwYSh4KSJdLFswLDEsIlxcSmNhbFxcb3RpbWVzXFxrYXBwYSh4KSJdLFsyLDEsIlxcT21lZ2FeezF9X3tcXEFee259X3tcXGthcHBhKHkpfS9cXGthcHBhKHkpfVxcb3RpbWVzXFxrYXBwYSh4KSJdLFs0LDEsIlxcT21lZ2FeezF9X3tYX3t5fS9cXGthcHBhKHkpfVxcb3RpbWVzXFxrYXBwYSh4KSJdLFs1LDAsIjAiXSxbNSwxLCIwIl0sWzAsMV0sWzEsMl0sWzQsNV0sWzMsNF0sWzAsMywiIiwxLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoiZXBpIn19fV0sWzEsNCwiXFx3ciIsMl0sWzIsNSwiXFx3ciIsMl0sWzIsNl0sWzUsN11d
   \begin{tikzcd}
       {\Ical_{X}/\Ical_{X}^{2}\otimes\kappa(x)} && {\Omega^{1}_{\A^{n}_{Y}/Y}|_{i(X)}\otimes\kappa(x)} && {\Omega^{1}_{X/Y}\otimes\kappa(x)} & 0 \\
       {\Jcal\otimes\kappa(x)} && {\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}\otimes\kappa(x)} && {\Omega^{1}_{X_{y}/\kappa(y)}\otimes\kappa(x)} & 0
       \arrow[from=1-1, to=1-3]
       \arrow[two heads, from=1-1, to=2-1]
       \arrow[from=1-3, to=1-5]
       \arrow["\wr"', from=1-3, to=2-3]
       \arrow[from=1-5, to=1-6]
       \arrow["\wr"', from=1-5, to=2-5]
       \arrow[from=2-1, to=2-3]
       \arrow[from=2-3, to=2-5]
       \arrow[from=2-5, to=2-6]
   \end{tikzcd}$$
   where the injectivity of the right two vertical arrows implies surjectivity of the leftmost vertical arrow. 

   If $n>d$, there is $g\in\Ical_{X}$ and $g_{2},\dots,g_{n}\in\Ocal_{\A^{n}_{\kappa(y)}}$ such that $\dform g,\dform g_{2},\dots,\dform g_{n}$ freely generate $\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}\otimes\kappa(x)$. By Nakayama's lemma, these lift to basis of $\Omega^{1}_{\A^{n}_{\kappa(y)}/\kappa(y)}\otimes\kappa(x')$ for $x'$ in a neighborhood of $x$ in $X$. Observe $X\subseteq V(g)=W\subseteq \A^{n}_{Y}$ then $\dim(W)=\dim(\A^{n}_{Y})-1$ and with $\Omega_{W'_{y}/\kappa(y)}^{1}=\Omega_{\A^{n}_{\kappa(y)}/\kappa(y)}/\dform g$ which is locally free of rank $n-1$. Moreover, since $g$ is a nonzerodivisor in $\Ocal_{X,x}/\mfrak_{y}\Ocal_{X,x}$, $W_{y}\to y$ is flat by \Cref{prop: properties of flatness rings and modules} (vi). 
   
   Iterating this process, we arrive at the desired $W$. 
\end{proof}
\begin{example}
    Let $X=\{y\}\hookrightarrow Y$ a closed point. $\Omega_{X/Y}^{1}=0$ and the fiber dimension is 0, but taking $W=Y$, $\id_{Y}:Y\to Y$ is smooth. 
\end{example}
We now state and prove the desired result. 
\begin{proposition}\label{prop: smoothness via relative cotangent}
    Let $f:X\to Y$ be a morphism locally of finite type with all fibers of pure dimension $d$. Then $f$ is smooth if and only if $f$ is flat and $\Omega_{X/Y}^{1}$ is locally free of rank $d$. 
\end{proposition}
\begin{proof}
    Recall by \Cref{prop: differentials of pushouts} that for a Cartesian square 
    $$% https://q.uiver.app/#q=WzAsNCxbMCwwLCJYJyJdLFswLDEsIlknIl0sWzIsMCwiWCJdLFsyLDEsIlkiXSxbMCwyLCJnIl0sWzIsM10sWzEsM10sWzAsMV1d
    \begin{tikzcd}
        {X'} && X \\
        {Y'} && Y
        \arrow["g", from=1-1, to=1-3]
        \arrow[from=1-1, to=2-1]
        \arrow[from=1-3, to=2-3]
        \arrow[from=2-1, to=2-3]
    \end{tikzcd}$$
    we have $g^{*}\Omega^{1}_{X/Y}\cong\Omega_{X'/Y'}$ so in particular when $Y'=\spec(\kappa(y))$ then $X'=X_{y}$ and we have $\Omega^{1}_{X_{y}/\kappa(y)}\cong\Omega^{1}_{X/Y}|_{X_{y}}$. We now begin the proof in earnest. 

    $(\Rightarrow)$ Now assume $f$ is smooth. By definition, $f$ is flat, and $\Omega_{X_{y}/\kappa(y)}^{1}$ is locally free of rank $\dim(X_{y})$. In particular, the rank of $\Omega^{1}_{X_{y}/\kappa(y)}\otimes\kappa(x)$ is $d$ for all $x\in X_{y}$. By base change, $\Omega^{1}_{X_{y}/\kappa(y)}\otimes\kappa(x)$ and $\Omega^{1}_{X/Y}\otimes\kappa(x)$ are of the same rank. If $X$ is reduced, this already implies that $\Omega_{X/Y}^{1}$ is locally free of the correct rank. 

    If $X$ is not reduced, we use the factorization produced by \Cref{lem: is closed of flat} to get a factorization 
    $$% https://q.uiver.app/#q=WzAsMyxbMCwwLCJYIl0sWzIsMCwiVyJdLFsxLDEsIlkiXSxbMCwyLCJmIiwyXSxbMCwxLCJpIl0sWzEsMiwicCJdXQ==
    \begin{tikzcd}
        X && W \\
        & Y
        \arrow["i", from=1-1, to=1-3]
        \arrow["f"', from=1-1, to=2-2]
        \arrow["p", from=1-3, to=2-2]
    \end{tikzcd}$$
    where $i$ is a closed immersion and $p$ is smooth with fiber dimension $d$. We have $X_{y}\subseteq W_{y}$ of the same dimension, but $W_{y}$ is smooth hence reduced, so $X_{y}=W_{y}$ yielding the claim. 

    $(\Leftarrow)$ Suppose $f$ is flat and $\Omega_{X/Y}^{1}$ is locally free of rank $d$. The restriction to the fiber $\Omega_{X_{y}/\kappa(y)}^{1}$ is locally free of rank $\dim(X_{y})$ over $\kappa(y)$ hence smooth over $\kappa(y)$ showing the morphism is smooth. 
\end{proof}
As in the case of smoothness \Cref{prop: smooth on open}, the smooth locus of a morphism can be shown to be open on the source. 
\begin{proposition}\label{prop: smooth locus is open on source}
    Let $f:X\to Y$ be a dominant morphism of finite type integral schemes over $k$ with $K(X)/K(Y)$ separable. There exists $U\subseteq X$ dense open such that $f|_{U}:U\to Y$ is smooth. 
\end{proposition}
\begin{proof}
    Since $K(X)/K(Y)$ is separable, $\Omega^{1}_{K(X)/K(Y)}$ is a $K(X)$-vector space of rank the transendence degree of $K(X)/K(Y)$, which is $d=\dim(X)-\dim(Y)$. By \Cref{lem: free modules over local rings}, we have that there is an open set $U$ such that $\Omega^{1}_{X/Y}|_{U}\cong\Omega^{1}_{U/Y}$ is locally free of rank $d$. 

    By \Cref{prop: flatness is universally open}, we can by restricting further take $U$ to be the flat locus of the morphism, which may be empty. On $U$, the fibers over $y\in f(U)$ are of dimension $d$ by \Cref{corr: fiberwise flatness} (applied to $U$ and not $Y$). So by \Cref{prop: smoothness via relative cotangent}, $f|_{U}$ is smooth. 
\end{proof}
\begin{remark}
    The special case of \Cref{prop: smooth locus is open on source} where $Y=\spec(k)$ is precisely \Cref{prop: smooth on open}. 
\end{remark}
Let us consider some examples. 
\begin{example}\label{ex: cotangent ses}
    A smooth morphism between smooth schemes extends the exact sequence of \Cref{prop: tensor exact sequence} to a short exact sequence. Let $f:X\to Y$ be a smooth morphism between smooth $k$-schemes. There is a short exact sequence 
    \begin{equation}\label{eqn: cotangent ses}
        0\to f^{*}\Omega^{1}_{Y/k}\to\Omega_{X/k}^{1}\to\Omega_{X/Y}\to0.
    \end{equation}
    To see this, we observe that since $\Omega_{X/Y}^{1}$ is locally free of rank $\dim(X)-\dim(Y)$ and $\Omega_{X/k}^{1}$ is locally free of rank $\dim(X)$ implying $f^{*}\Omega_{Y/k}^{1}$ locally free of rank the dimension of $Y$. This implies that $f^{*}\Omega_{Y/k}^{1}\to\ker\left(\Omega^{1}_{X/k}\to\Omega^{1}_{X/Y}\right)$ is surjective, but any surjection of locally free modules of the same rank is an isomorphism, whence the claim. 
\end{example}
\begin{example}\label{ex: normal bundle es}
    Let $f:X\to Y$ be a smooth morphism between smooth $k$-schemes. Dualizing (\ref{eqn: cotangent ses}) of \Cref{ex: cotangent ses}, we get 
    $$0\to\Tcal_{X/Y}\to\Tcal_{X/k}\to f^{*}\Tcal_{Y/k}\to0$$
    which on restriction to any closed fiber $X_{y}$ we have 
    $$0\to\Tcal_{X/Y}|_{X_{y}}\cong\Tcal_{X_{y}}\to\Tcal_{X}|_{X_{y}}\to f^{*}\Tcal_{Y}|_{y}\cong\Ncal_{X_{y}/Y}\to0$$
    recovering the normal bundle sequence. 
\end{example}
Observe that for $f:X\to Y$ a smooth morphism between smooth $k$-schemes with $k$-algebraically closed we have for all $x\in X$ an induced map on the Zariski tangent spaces $T_{X,x}\to T_{Y,f(x)}\otimes\kappa(x)$. In particular, if $x\in X(k)$ we have $\kappa(x)\cong k$ and thus $\kappa(y)\cong k$ as $\kappa(y)$ lies in the intermediate extension $\kappa(x)/\kappa(y)/k$. By the injectivity of the idnuced map $\mfrak_{y}/\mfrak_{y}^{2}\to\mfrak_{x}/\mfrak_{x}^{2}$, we have surjectivity of the map on Zariski tangent spaces. This in fact determines smoothness of a morphism under appropriate hypotheses. 
\begin{proposition}\label{prop: surjectivity of tangent spaces and smoothness}
    Let $f:X\to Y$ be a morphism between smooth $k$-schemes with $k$ algebraically closed. If the induced map $T_{X,x}\to T_{Y,f(x)}$ is surjective for all $x\in X(k)$ then $f$ is smooth. 
\end{proposition}
\begin{proof}
    We show first that $f$ is flat. Since flatness is an open condition, it suffices to show flatness on each closed point, since each point lies in an open neighborhood of some closed point. 

    By injectivity of $\mfrak_{y}/\mfrak_{y}^{2}\hookrightarrow\mfrak_{x}/\mfrak_{x}^{2}$ we pick generators $(\overline{a}_{1},\dots,\overline{a}_{n})$ where $n=\dim(Y)$ with images $\overline{b}_{1},\dots\overline{b}_{n}$ for $b_{i}\in\mfrak_{x}$. Injectivity implies that the $\overline{b}_{i}$ remain linearly independent in the quotient so $b_{1},\dots,b_{n}$ is a regular sequence in $\Ocal_{X,x}$ -- each $b_{i}$ is a nonzerodivisor in $\Ocal_{X,x}/(b_{1},\dots,b_{i-1})$. By induction, $\Ocal_{X,x}/(b_{1},\dots,b_{n})$ is flat over $\kappa(y)=\Ocal_{Y,f(x)}/(a_{1},\dots,a_{n})$. This gives flatness. 
    
    Use \Cref{prop: tensor exact sequence}, we have 
    $$f^{*}\Omega^{1}_{Y/k}\to\Omega_{X/k}^{1}\to\Omega_{X/Y}^{1}\to0$$
    where the former two terms are locally free and surjectivity of the Zariski tangent space implies that the map $f^{*}\Omega^{1}_{Y/k}\to\Omega_{X/k}^{1}$ is fiberwise injective. Hence $\Omega^{1}_{X/Y}$ is locally free of $\dim(X)-\dim(Y)$ showing smoothness too. 
\end{proof}
We hint towards an algebro-geometric version of Sard's theorem via the following lemma, which will be used in the proof of the result. 
\begin{lemma}\label{lem: rank locus is bounded}
    Let $f:X\to Y$ be smooth finite type $k$-schemes with $k$ of characterositic 0. Define 
    $$X_{r}=\overline{\left\{x\in X_{\mathrm{cl}}:\mathrm{rank}(T_{X,x}\to T_{Y,f(x)}\otimes\kappa(x))\leq r\right\}}.$$
    Then $\dim(\overline{f(X_{r})})\leq r$. 
\end{lemma}
\begin{proof}
    Pick an irreducible component $X'\subseteq\overline{X_{r}}$ such that $f':X'\to Y'$ is dominant. Given $X',Y'$ the induced reduced subscheme structure so $X',Y'$ are integral. Using that $K(X')/K(Y')$ is separble since $K(Y')$ is of characteristic 0, there exists by \Cref{prop: smooth locus is open on source} $U'$ of $X'$ such that $f'|_{U'}:U'\to Y'$ is smooth. Then take $x\in U'\cap X_{r}$ and contemplate the diagram 
    $$% https://q.uiver.app/#q=WzAsNCxbMCwwLCJUX3tVJyx4fSJdLFsyLDAsIlRfe1gseH0iXSxbMCwxLCJUX3tZJyxmKHgpfSJdLFsyLDEsIlRfe1ksZih4KX0iXSxbMCwxLCIiLDAseyJzdHlsZSI6eyJ0YWlsIjp7Im5hbWUiOiJob29rIiwic2lkZSI6InRvcCJ9fX1dLFsyLDMsIiIsMCx7InN0eWxlIjp7InRhaWwiOnsibmFtZSI6Imhvb2siLCJzaWRlIjoidG9wIn19fV0sWzEsM10sWzAsMiwiIiwxLHsic3R5bGUiOnsiaGVhZCI6eyJuYW1lIjoiZXBpIn19fV1d
    \begin{tikzcd}
        {T_{U',x}} && {T_{X,x}} \\
        {T_{Y',f(x)}} && {T_{Y,f(x)}}
        \arrow[hook, from=1-1, to=1-3]
        \arrow[two heads, from=1-1, to=2-1]
        \arrow[from=1-3, to=2-3]
        \arrow[hook, from=2-1, to=2-3]
    \end{tikzcd}$$
    where the injective horizontal maps and the right vertical map being of rank $r$ imply surjectivity of the left vertical map and smoothness of $U'\to Y'$. Indeed, it suffices to take $x$ to be $k$-rational, since the preceding discussion holds on base change.Thus $T_{Y',f(x)}$ is of rank at most $r$, showing $\dim(\overline{f(X_{r})})\leq r$, as desired. 
\end{proof}
